---
title: "Relatório CID11"
author: "Franco Lovatti"
date: "18/10/2024"
output:
  bookdown::html_document2: 
    toc: true
    toc_float: true
    latex_engine: xelatex
  bookdown::pdf_document2: default
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE
)
```

```{r message=FALSE, warning=FALSE, include=FALSE}

# instalar e carregar pacotes

pacman::p_load("tidyverse", "janitor", "Hmisc",
               "summarytools", "DataExplorer", 
               "knitr","readr", "dplyr", "glue", "scales",
               "geobr", "sf", "latex2exp", "patchwork", "plotly")


#LER E SALVAR DADOS TOTAIS BR


dados_br_total <- c()

for (ano in 2013:2022) {
  
  df <- readRDS(paste0("Bases/bases_de_dados/dados_", ano,".rds"))
  dados_br_total <- bind_rows(df,dados_br_total)
  
}


#ADICIONANDO COLUNAS EXTRAS

#criar coluna do ano em que o obito ocorreu
dados_br_total$DTOBITO <- ymd(dados_br_total$DTOBITO)
dados_br_total$ANOOBITO <- year(dados_br_total$DTOBITO)

#criar coluna da idade em anos completos
dados_br_total$DTNASC  <- ymd(dados_br_total$DTNASC)  
dados_br_total$DTOBITO  <- ymd(dados_br_total$DTOBITO)
dados_br_total$IDADE2  <- floor(interval(start  =  dados_br_total$DTNASC , 
                                         end = dados_br_total$DTOBITO) / years(1)) # arrendondado p baixo - anos completos


#codigos UF

codigosUF <- read_table("Bases/var_extras_UF.txt")

codigosUF$codigoUF <- as.character(codigosUF$codigoUF)


# criando a var codigosUF

dados_br_total <- dados_br_total %>% 
  mutate(
    codigoUF = substr(as.character(CODMUNOCOR), 1, 2)
  )

dados_br_total <- inner_join(dados_br_total, codigosUF, by = "codigoUF")



dados_es_total <- dados_br_total %>%
  filter(Sigla == "ES")


#ler codigos das cids que tem a ver com uso de psicoativos
codigos_psic <- readLines("Bases/codigos_psic.txt")



#---------- Filtrar cids na variavel CAUSABAS

### BR PSIC
dados_br_psic <- dados_br_total%>%
  filter(str_detect(toupper(CAUSABAS), paste(codigos_psic, collapse = "|")))

### ES PSIC
dados_es_psic <- dados_es_total %>%
  filter(str_detect(toupper(CAUSABAS), paste(codigos_psic, collapse = "|")))
```

```{r}
### Nossos relatórios terão como base as cores BRANCO e AZUL
# No entanto, utilizar apenas estas 2 cores é bastante limitante
# Então, outras cores auxiliares podem ser utilizadas, 
# quando for necessário CONTRASTE

# Caso não seja necessário contraste, utilizar a PALETA PRINCIPAL



# paleta de series === CORES VIVAS (primárias) POIS AS LINHAS SÃO FINAS


paleta_series <- manual_pal(c("#010440","#ff7f00","#1e96fc", "#ff6392", 
                              "#009D00","#9381ff" ,"#e31a1c", "#25a18e", 
                              "#FFDB58"
                        ))


paleta_lococor <- c(
  "Aldeia Indígena" = "#010440",
  "Hospital" = "#1e96fc",
  "Domicílio" = "#ff7f00",
  "Via pública" = "#e31a1c",
  "Outro estabelecimento de saúde" = "#ff6392",
  "Outros" = "#009D00")

# paleta de histograma === SIMILAR A DE SÉRIES PORÉM COM CORES MAIS AGRADÁVEIS DE OLHAR

paleta_hist <- manual_pal(c("#A6CEE3", "#FB9A99", "#FFDB58", "#1F78B4",
                            "#B2DF8A","#33A02C", "#8F8164"
                            ))



#"#c8cd3b"
# paleta de histograma VARIÁVEL ORDINAL = EXEMPLO (FAIXAS ETÁRIAS)



paleta_hist_ordinal <- function(n){
  # Cria a função geradora de paleta
  paleta_func <- colorRampPalette(c("#9AC7D9", "#010440"))
  
  # Gera a paleta de cores com n cores
  paleta <- paleta_func(5)
  
  paleta <- manual_pal(paleta)
  
  return(paleta(n))
}



# PALETA GRADIENTE (CORES CONTÍNUAS) (EXEMPLO: HEATMAP)


scale_fill_gradient(low = "lightblue", high = "#010440")


# AZUIS QUE PODEM SER ÚTEIS PARA DETALHES

paleta_azul <- manual_pal(c("#FFFFFF","#E0E0E0", "#8A8A8A", "#496373",  
                      
                            "#9AC7D9", "#024059","#223459", "#0000FF","#010440", 
                      
                      "#222333","#2B2B33", "#000000"))


#TAMANHO DO TEXTO DA LEGENDA
size_titulo_legenda <- 12
size_texto_legenda <- 10

```

# Introdução

Os gráficos abaixo mostram quais as CID’s com maior número de ocorrências tanto no Brasil quanto no Espírito Santo. Percebe-se que transtornos por uso de álcool e fumo além de doenças hepáticas associadas com alcoolismo são as CIDs mais frequentes tanto no Brasil quanto no Espírito Santo.

```{r}
library(readxl)
library(reshape2)
CIDS2 <- read_excel("Bases/CIDS2.xlsx")

# criando vetor de CIDs por psicoativo ------------------------------------

vet.CIDpsic2 <- unique(CIDS2$cid)

#n=10:19


#vet.CIDpsic2 <- paste(c("F"), n,
                     # sep = "", collapse = ",")

#vet.CIDpsic2 <- strsplit(vet.CIDpsic2, ",") %>%
 # unlist()


# criando contagens das CIDs ES e BR --------------------------------------

contagens.CID_es=c()
contagens.CID_br=c()

for (i in vet.CIDpsic2) {

  count_CID <- dados_es_psic$CAUSABAS %>% str_count(pattern = i) %>%
    sum()
  contagens.CID_es[i] <- count_CID
}

for (i in vet.CIDpsic2) {

  count_CID <- dados_br_psic$CAUSABAS %>% str_count(pattern = i) %>%
    sum()
  contagens.CID_br[i] <- count_CID
}



# construindo dados das proporções ----------------------------------------


dados.count.CID <- data.frame(CIDs = vet.CIDpsic2,
                            Contagens = c(contagens.CID_es, contagens.CID_br),
                            Localidade = c(rep("Espírito Santo", length(contagens.CID_es)),
                                           rep("Brasil", length(contagens.CID_br))))

dados.count.CID <- full_join(

  dados.count.CID %>%
  filter(Localidade == "Brasil") %>%
  mutate(prop = Contagens*100/sum(Contagens)),

  dados.count.CID %>%
  filter(Localidade == "Espírito Santo") %>%
  mutate(prop = Contagens*100/sum(Contagens))

)



# montando o plot ---------------------------------------------------------

g_count_CIDs <- dados.count.CID %>%
  group_by(Localidade) %>%
  slice_max(order_by = prop, n = 10) %>%  # Seleciona as 10 maiores categorias por localidade
  ungroup() %>%  # Remove o agrupamento para aplicar fct_reorder corretamente
  mutate(CIDs = fct_reorder(CIDs, prop)) %>%
  ggplot(aes(x = CIDs, y = prop)) +
  geom_col(aes(text = paste("CID: ", CIDs, "<br>Percentual: ", 
                            round(prop, 2), "%"))
           ,fill = paleta_hist(1)) +
  facet_grid(rows = vars(Localidade))+
  labs(title = "Porcentual de Óbitos por CID no Brasil 
e Espírito Santo", y="Percentual", x="CIDs")+
  theme_classic() + coord_flip() + theme(title = element_text(size = 15),
                                         axis.text = element_text(size = 13),
                                         strip.text = element_text(face = "bold", size = 15),
                                         legend.title = element_text(size = size_titulo_legenda),               
                                         legend.text = element_text(size = size_texto_legenda))

ggplotly(g_count_CIDs, tooltip = "text")


#save(g_count_CIDs, file="graficos/g_count_CIDs.RData")


# preparando dados para heatmap por cids vs anos ------------------------------------

```


# Indicadores

## Indicador 1

O primeiro indicador desenvolvido mostra quantas pessoas morreram por
psicoativos no Espírito Santo a cada 100 mortes totais no estado

$$
I_1 = \frac{\text{Nº de Óbitos Decorrentes do Uso de Psicoativos no Espírito Santo}}{\text{Nº de Óbitos Totais de indívidus com mais de 18 anos no Espírito Santo}} \cdot 1000
$$

É possível observar que os números de mortes relacionadas ao uso de substâncias a
cada 1000 mortes totais teve tendência de queda até o ano de 2020. Em 2022, após uma crescente a partir de 2020, este indicador alcança o patamar que estava em 2017.


```{r echo=FALSE}

# MONTANDO OS DADOS INDICADOR 1

dados_indic1 <- inner_join(
  data.frame(
    dados_es_psic %>% group_by(ANOOBITO) %>%
      summarise(N.obitos = n())
  ),
  data.frame(
    dados_es_total %>%
      filter(IDADE2>17) %>%
      group_by(ANOOBITO) %>%
      summarise(N.obitos = n())
  ),

  by="ANOOBITO"

)

colnames(dados_indic1) <- c("ANOOBITO", "N_obitos_es_psic", "N_obitos_es_total")

attach(dados_indic1)

dados_indic1$indic1 <- (N_obitos_es_psic/N_obitos_es_total)*1000


# montando o grafico
serie_indic1 <- ggplot(data = dados_indic1, 
                       aes(x = ANOOBITO, 
                           y = indic1
                           )) +
  geom_line(linetype = "solid", color = paleta_series(1),
            linewidth = 0.5)+
  geom_point(shape = 15, color = paleta_series(1), 
             aes(text = paste("Ano: ", ANOOBITO, 
                 "<br>Indicador 1: ", 
                  round(indic1, 2)))) +
  labs(title = "Série do Indicador 1 de 2013 a 2022",
       x="Anos", y="Obitos/1000") +
  scale_x_continuous(
    breaks = dados_indic1$ANOOBITO,
    labels = dados_indic1$ANOOBITO)+
  scale_y_continuous(limits = c(0,50),
      breaks = seq(0,50, by=10))+
  theme_classic()+
  theme(plot.title = element_text(size = 13),
        legend.title = element_text(size = size_titulo_legenda),               
        legend.text = element_text(size = size_texto_legenda))

ggplotly(serie_indic1, tooltip = "text")


```


## Indicadores 2 e 3

Os indicadores 2 e 3 mostram, respectivamente 1) o número de mortes por
psicoativos no Espírito Santo a cada 100 mortes por psicoativos no Brasil e 2) o
número de mortes totais no estado a cada 100 mortes totais no país.

Através deles é possível verificar que a participação do Espírito Santo em óbitos por psicoativos no Brasil é maior que a participação do Espírito Santo quando visto para os óbitos totais no país. Isto demonstra o impacto do Espírito Santo nos óbitos por psicoativos no Brasil.  Enquanto a participação do estado nos óbitos totais esteve sempre entre 1,5% a 2%, o impacto do estado do Espírito Santo, quando analisado os óbitos sob o recorte das CIDs relacionadas a substâncias psicoativas, foi de 2,3% a 3%

$$
I_2 = \frac{\text{Nº de Óbitos Decorrentes do Uso de Psicoativos no Espírito Santo}}{\text{Nº de Óbitos Decorrentes do uso de Psicoativos no Brasil}} \cdot 100
$$

<br>

$$
I_3 = \frac{\text{Nº de Óbitos Totais no Espírito Santo}}{\text{Nº de Óbitos Totais no Brasil}}\cdot 100
$$


```{r}
# MONTANDO OS DADOS INDICADOR 2

dados_indic2 <- inner_join(
  data.frame(
    dados_es_psic %>% group_by(ANOOBITO) %>%
      summarise(N.obitos = n())
  ),
  data.frame(
    dados_br_psic %>% group_by(ANOOBITO) %>%
      summarise(N.obitos = n())
  ),

  by="ANOOBITO"

)

colnames(dados_indic2) <- c("ANOOBITO", "N_obitos_es_psic", "N_obitos_br_psic")

attach(dados_indic2)

dados_indic2$indic2 <- (N_obitos_es_psic/N_obitos_br_psic)*100


##save(serie_indic1, file="GRAFICOS_RDA/serie_indic2.RData")



# MONTANDO OS DADOS INDICADOR 3

dados_indic3 <- inner_join(
    data.frame(
    dados_es_total %>%
      group_by(ANOOBITO) %>%
      summarise(N.obitos = n())
  ),
  data.frame(
    dados_br_total %>%
      group_by(ANOOBITO) %>%
      summarise(N.obitos = n())
  ),

  by="ANOOBITO"

)

colnames(dados_indic3) <- c("ANOOBITO", "N_obitos_es_total", "N_obitos_br_total")

attach(dados_indic3)

dados_indic3$indic3 <- (N_obitos_es_total/N_obitos_br_total)*100





#DADOS INDIC 2 e 3

dados_indic2_3 <- data.frame(
      Ano = rep(dados_indic2$ANOOBITO, 2),
      valor = c(dados_indic2$indic2,
                dados_indic3$indic3),
      Indicador = c(rep("Indicador 2", 10),
                    rep("Indicador 3", 10))
)


# montando o grafico
serie_indic2_3 <- ggplot(data = dados_indic2_3, aes(x = Ano, y = valor,
                                                    colour = Indicador)) +
  geom_line(linetype = "solid",
            linewidth = 0.5) +
  geom_point(shape = 15, 
             aes(text = paste("Ano: ", Ano, 
                              "<br> Percentual: ", 
                              round(valor, 2), "%", 
                              "<br>", Indicador))) +
  labs(title = "Indicador 2 e Indicador 3 de 2013 a 2022",
       x="Anos", y="Obitos/100") +
  scale_colour_manual(values = paleta_series(2), name = "Indicadores",
            labels = c("Indicador 2", "Indicador 3")) +
  ylim(1.5, 3.5) +
  scale_x_continuous(
    breaks = dados_indic2_3$Ano,
    labels = dados_indic2_3$Ano)+
  scale_y_continuous(limits = c(0,3.5),
                     breaks = seq(0,3.5, by=0.5))+
  theme_classic()+
  theme(legend.title = element_text(size = size_titulo_legenda),               
        legend.text = element_text(size = size_texto_legenda))

ggplotly(serie_indic2_3, tooltip = "text")

#save(serie_indic2_3, file="GRAFICOS_RDA/serie_indic2_3.RData")

```

## Indicadores 4 e 5

Os indicadores 4 e 5 mostram o número de óbitos por psicoativos em
relação a população do Brasil e do Espírito Santo. Através deles é
possível compreender que enquanto no Brasil o número de óbitos por
psicoativos a cada 100.000 habitante variou de 10 a 14, no Espírito Santo
esse número variou de 13 a aproximadamente 18 óbitos a cada 100.000
habitantes, portanto, sempre esteve acima do Brasil.

$$
I_4 = \frac{\text{Nº de Óbitos Decorrentes do Uso de Psicoativos no Espírito Santo}}{\text{População Estimada do Espírito Santo no ano correspondente}} \cdot 100000
$$

<br>

$$
I_5 = \frac{\text{Nº de Óbitos Decorrentes do Uso de Psicoativos no Brasil}}{\text{População Estimada do Brasil no ano correspondente}} \cdot 100000
$$


```{r}

### Indicador 4 obitos psic ES/pop ES
pop_es_2022 <- data.frame(codigoUF = "32",
                          ano = "2022",
                          valor  = c(3833712))

pop13a21 <- readRDS("Bases/pop13a21.rds")

dados_indic4 <- pop13a21 %>%
  dplyr::filter(codigoUF == 32) %>%
  select(codigoUF, ano, valor) %>%
  bind_rows(pop_es_2022)

dados_indic4$ano <- as.numeric(dados_indic4$ano)

dados_indic4 <- dados_indic4 %>%  inner_join(
  data.frame(
    dados_es_psic %>% group_by(ANOOBITO) %>%
      summarise(N.obitos = n())
  ),

  by = c("ano" = "ANOOBITO")
)


### Indicador 5 obitos psic BR/pop BR
pop_br_2022 <- data.frame(codigoUF = "1",
                          ano = "2022",
                          valor  = c(
                            203080756))

dados_indic5 <- pop13a21 %>%
  dplyr::filter(codigoUF == 1) %>%
  select(ano, valor, codigoUF) %>%
  rbind(pop_br_2022)

dados_indic5$ano <- as.numeric(dados_indic5$ano)

dados_indic5 <- dados_indic5 %>%  inner_join(
  data.frame(
    dados_br_psic %>% group_by(ANOOBITO) %>%
      summarise(N.obitos = n())
  ),

  by = c("ano" = "ANOOBITO")
)



### MONTANDO DADOS
dados_indic4_5 <- data.frame(
  Ano = rep(dados_indic4$ano, 2),
  valor = c(dados_indic4$valor,
            dados_indic5$valor),
  N.obitos = c(dados_indic4$N.obitos,
               dados_indic5$N.obitos),
  Indicador = c(rep("Indicador 4", 10),
                rep("Indicador 5", 10))
)


serie_indic4_5 <- ggplot(data = dados_indic4_5, aes(x = Ano, y = (N.obitos/valor)*100000,
                                                    colour = Indicador)) +
  geom_line(linetype = "solid",
            linewidth = 0.5) +
  geom_point(shape = 15, aes(text = paste("Ano: ", Ano, 
                                    "<br> Valor: ", 
                                    round((N.obitos/valor)*100000, 2), 
                                    "<br>", Indicador))) +
  labs(title = "Indicador 4 e Indicador 5 de 2013 a 2022",
       x="Anos", y="Óbitos/100000") +
  scale_colour_manual(values = paleta_series(2), name = "Indicadores",
                      labels = c("Indicador 4", "Indicador 5")) +
  #ylim(1.5, 3.5) +
  scale_x_continuous(
    breaks = dados_indic4_5$Ano,
    labels = dados_indic4_5$Ano)+
  scale_y_continuous(limits = c(0,20),
                     breaks = seq(0,20, by=2))+
  theme_classic()+
  theme(legend.title = element_text(size = size_titulo_legenda),               
        legend.text = element_text(size = size_texto_legenda))

ggplotly(serie_indic4_5, tooltip = "text")

```


# Mapas

O mapa abaixo apresenta o cenário nacional, por estado, do número de óbitos por psicoativos sobre 100.000 habitantes no ano de 2013. É possível perceber que o estado do Espírito Santo em 2013 possuia a maior taxa de óbitos a cada 100000 habitantes.

```{r message=FALSE, warning=FALSE}

library(sf)
library(lwgeom)
# baixando info estados brasil (geobr) ------------------------------------

brasil = read_state(code_state = "all", year = 2018)
pop13a21<-readRDS("Bases/pop13a21.rds")
### MAPA DO BRASIL OBITOS POR ESTADO POR PSICO/POP ESTADO 2013 e 2022


### numeros de obitos por estado 13 e 22
dados_mapa_psic_pop13 <- data.frame(
  dados_br_psic %>%
    filter(ANOOBITO == "2013") %>%
    group_by(codigoUF, ANOOBITO) %>%
    summarise(N.obitos = n()))

dados_mapa_psic_pop22 <- data.frame(
  dados_br_psic %>%
    filter(ANOOBITO == "2022") %>%
    group_by(codigoUF, ANOOBITO) %>%
    summarise(N.obitos = n()))

### selecionando pop de 2013 dos estados
pop_UF_13 <- pop13a21 %>%
  filter(ano == "2013" & codigoUF != 1) %>%
  reframe(unique(valor), codigoUF, ano)

pop_UF_13 <- rename(pop_UF_13, pop13 = `unique(valor)`)

dados_mapa_psic_pop13<- left_join(dados_mapa_psic_pop13,pop_UF_13,
                                  by = "codigoUF")


var_extras_UF <- read_table("Bases/var_extras_UF.txt")

dados_mapa_psic_pop13$codigoUF <- as.numeric(dados_mapa_psic_pop13$codigoUF)
dados_mapa_psic_pop22$codigoUF <- as.numeric(dados_mapa_psic_pop22$codigoUF)

#preparando dados com as siglas
dados_mapa_psic_pop13 <- left_join(dados_mapa_psic_pop13, var_extras_UF,
                                   by = c("codigoUF"))

dados_mapa_psic_pop22<- left_join(dados_mapa_psic_pop22, var_extras_UF,
                                  by = c("codigoUF"))


# joins com base brasil coordenadas
dados_mapa_psic_pop13 <- brasil %>%
  left_join(dados_mapa_psic_pop13, by = c("abbrev_state"="Sigla"))

dados_mapa_psic_pop22 <- brasil %>%
  left_join(dados_mapa_psic_pop22, by = c("abbrev_state"="Sigla"))

set.seed(0411)

points_within <- st_sample(dados_mapa_psic_pop13, size = 10000, type = "random")  # Ajuste o 'size' conforme necessário

# Converter os pontos gerados em um dataframe com a geometria correta
points_within_df_13 <- st_as_sf(points_within) %>%
  st_set_crs(st_crs(dados_mapa_psic_pop13)) %>%
  st_join(dados_mapa_psic_pop13) %>%
  mutate(label = paste("UF: ", abbrev_state, "<br>Taxa de Óbitos: ", round((N.obitos / pop13) * 100000, 2)))


# Converter os pontos gerados em um dataframe com a geometria correta
points_within_df_22 <- st_as_sf(points_within) %>%
  st_set_crs(st_crs(dados_mapa_psic_pop22)) %>%
  st_join(dados_mapa_psic_pop22) %>%
  mutate(label = paste("UF: ", abbrev_state, "<br>Taxa de Óbitos: ", round((N.obitos / pop22) * 100000, 2)))


# Verificar se a geometria está correta

mapa_psic_pop13 <- ggplot() +
  geom_sf(data = dados_mapa_psic_pop13, 
          aes(fill = (N.obitos/pop13)*100000),
          color = "#788881")+ 
  geom_sf(data = points_within_df_13, aes(text = label),
          color = "transparent") +
  scale_fill_gradient(low = "white", high = "#010440",limits = c(0,22),
                      name="Óbitos por 100000 hab.") +
  labs(title="Óbitos relacionados ao uso de psicoativos em 2013 a cada 100000 habitantes") +
  theme_void() + theme(title = element_text(size = 15),
                       axis.line = element_blank(),
                       legend.title = element_text(size = size_titulo_legenda),               
                       legend.text = element_text(size = size_texto_legenda))

ggplotly(mapa_psic_pop13, tooltip = "text")

```


Já este segundo mapa apresenta o mesmo indicador, porém calculado com os dados de 2022. As duas "fotografias", uma do ano de 2013 e a outra do ano de 2022, não consideram a evolução ao longo dos anos deste indicador, no entanto, traz visualmente a ideia do antes e depois. Em 2022, muitos estados possuem taxa maior que em 2013, assim como o Espírito Santo que deixou de possuir a maior taxa mas teve um aumento em relação a taxa de 2013. 

```{r}

mapa_psic_pop22 <- ggplot() +
  geom_sf(data = dados_mapa_psic_pop22, aes(fill = (N.obitos/pop22)*100000),
          color = "#788881")+
  geom_sf(data = points_within_df_22, aes(text = label),
          color = "transparent") +
  scale_fill_gradient(low = "white", high = "#010440", limits = c(0,22),
                      name="Obitos por 100000 hab.") +
  labs(title="Óbitos relacionados ao uso de psicoativos em 2022 a cada 100000 habitantes") +
  theme_void() + theme(title = element_text(size = 15),
                       axis.line = element_blank(),
                       legend.title = element_text(size = size_titulo_legenda),               
                       legend.text = element_text(size = size_texto_legenda))

ggplotly(mapa_psic_pop22, tooltip = "text")

```


# Dias da Semana


```{r}
## Dias da Semana

dados_dia_semana_br_total <- dados_br_total %>%
  mutate(diaobito_semana = wday(DTOBITO, label = TRUE, abbr = FALSE)) %>% 
  group_by(ANOOBITO, diaobito_semana) %>% 
  summarise(N.obitos = n(), .groups = 'drop') %>% 
  group_by(ANOOBITO) %>% 
  mutate(proporcao = N.obitos / sum(N.obitos))

dados_dia_semana_br_psic <- dados_br_psic %>%
  mutate(diaobito_semana = wday(DTOBITO, label = TRUE, abbr = FALSE)) %>%
  mutate(diaobito_semana = addNA(diaobito_semana)) %>% 
  group_by(ANOOBITO, diaobito_semana) %>% 
  summarise(N.obitos = n(), .groups = 'drop') %>% 
  group_by(ANOOBITO) %>% 
  mutate(proporcao = N.obitos / sum(N.obitos))

dados_dia_semana_es_total <- dados_es_total %>%
  mutate(diaobito_semana = wday(DTOBITO, label = TRUE, abbr = FALSE)) %>% 
  group_by(ANOOBITO, diaobito_semana) %>% 
  summarise(N.obitos = n(), .groups = 'drop') %>% 
  group_by(ANOOBITO) %>% 
  mutate(proporcao = N.obitos / sum(N.obitos))

dados_dia_semana_es_psic <- dados_es_psic %>%
  mutate(diaobito_semana = wday(DTOBITO, label = TRUE, abbr = FALSE)) %>% 
  group_by(ANOOBITO, diaobito_semana) %>% 
  summarise(N.obitos = n(), .groups = 'drop') %>% 
  group_by(ANOOBITO) %>% 
  mutate(proporcao = N.obitos / sum(N.obitos))


# Gráficos

# BR TOTAL

grafico_dia_br_total <- ggplot(
  dados_dia_semana_br_total, aes(x = factor(ANOOBITO), 
                                 y = proporcao, 
                                 fill = diaobito_semana,
                                 text = paste("Ano: ", factor(ANOOBITO),
                                              "<br>Dia da Semana: ", diaobito_semana,
                                              "<br> Proporção: ", proporcao))) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values=paleta_hist(7)) +  # Paleta de cores para os dias da semana
  labs(title = "Distribuição de Óbitos Totais no Brasil pelos Dias da Semana",
       x = "Ano",
       y = "Número de Óbitos",
       fill = "Dia da Semana") +
  theme_classic()

# BR PSIC
grafico_dia_br_psic <- ggplot(
  dados_dia_semana_br_psic, aes(x = factor(ANOOBITO), 
                                y = proporcao, 
                                fill = diaobito_semana,
                                text = paste("Ano: ", factor(ANOOBITO),
                                             "<br>Dia da Semana: ", diaobito_semana,
                                             "<br> Proporção: ", proporcao))) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values=paleta_hist(7)) +  # Paleta de cores para os dias da semana
  labs(title = "Distribuição de Óbitos por Psicoativos no Brasil pelos Dias da Semana",
       x = "Ano",
       y = "Número de Óbitos",
       fill = "Dia da Semana") +
  theme_classic()

# ES TOTAL

grafico_dia_es_total <- ggplot(
  dados_dia_semana_es_total, aes(x = factor(ANOOBITO), 
                                y = proporcao, 
                                fill = diaobito_semana,
                                text = paste("Ano: ", factor(ANOOBITO),
                                             "<br>Dia da Semana: ", diaobito_semana,
                                             "<br> Proporção: ", proporcao))) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values=paleta_hist(7)) +  # Paleta de cores para os dias da semana
  labs(title = "Distribuição de Óbitos Totais no ES pelos Dias da Semana",
       x = "Ano",
       y = "Número de Óbitos",
       fill = "Dia da Semana") +
  theme_classic()

# ES PSIC
grafico_dia_es_psic <- ggplot(
  dados_dia_semana_es_psic, aes(x = factor(ANOOBITO), 
                                y = proporcao, 
                                fill = diaobito_semana,
                                text = paste("Ano: ", factor(ANOOBITO),
                                               "<br>Dia da Semana: ", diaobito_semana,
                                               "<br> Proporção: ", proporcao))) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values=paleta_hist(7)) +  # Paleta de cores para os dias da semana
  labs(title = "Distribuição de Óbitos por Psicoativos no ES pelos Dias da Semana",
       x = "Ano",
       y = "Número de Óbitos",
       fill = "Dia da Semana") +
  theme_classic()

```


Os gráficos abaixo mostram que os óbitos categorizados por dias da semana não trazem informações relevantes para a busca de padrões ou tendências. Os óbitos totais, tanto no Brasil quanto no Espírito Santo, estão distribuídos com proporções quase iguais. O gráfico de óbitos por psicoativos no Brasil também não apresenta uma tendência aparente. Por último, para os óbitos por psicoativos no Espírito Santo, a variabilidade maior entre as proporções pelos dias na semana tem relação direta com a quantidade menor de observações. Portanto, esta não é uma variável relevante para ser analisada.

```{r echo=FALSE, message=FALSE, warning=FALSE}
subplot(style(ggplotly(grafico_dia_br_total, tooltip = "text"),
              showlegend = T)  |> 
          layout(legend = list(orientation = "h",
                               xanchor = "center",
                               x = 0.5),
                 annotations = list(x = 0.2 ,
                                    y = 1.05,
                                    text = "Mortes Totais BR",
                                    showarrow = F, 
                                    xref='paper', 
                                    yref='paper'),
                 xaxis = list(tickfont = list(size = 10)),
                 yaxis = list(tickfont = list(size = 10))),
        style(ggplotly(grafico_dia_es_total, tooltip = "text"), 
              showlegend = FALSE)  |> 
          layout(annotations = list(x = 0.6 ,
                                    y = 1.05,
                                    text = "Mortes Totais ES",
                                    showarrow = F,
                                    xref='paper', 
                                    yref='paper'),
                 xaxis = list(tickfont = list(size = 10)),
                 yaxis = list(tickfont = list(size = 10))))  |> 
  layout(title = 'Óbitos por Dias da Semana')
 
subplot(style( ggplotly(grafico_dia_br_psic, tooltip = "text"), showlegend = T)  |> 
          layout(legend = list(orientation = "h",
                               xanchor = "center",
                               x = 0.5),
                 annotations = list(x = 0.2 ,
                                    y = 1.05,
                                    text = "Mortes Psicoativos BR",
                                    showarrow = F,
                                    xref='paper',
                                    yref='paper'),
                 xaxis = list(tickfont = list(size = 10)),
                 yaxis = list(tickfont = list(size = 10))),
        style(ggplotly(grafico_dia_es_psic, tooltip = "text"), showlegend = F)  |> 
          layout(annotations = list(x = 0.6 ,
                                    y = 1.05,
                                    text = "Mortes Psicoativos ES",
                                    showarrow = F,
                                    xref='paper',
                                    yref='paper'),
                 xaxis = list(tickfont = list(size = 10)),
                 yaxis = list(tickfont = list(size = 10)))) |>
  layout(title = "")
```

# Horário

```{r}
## HORAOBITO


# BR TOTAL

dados_br_total$HORAOBITO <- as.numeric(dados_br_total$HORAOBITO)


dados_hora_br_total <- dados_br_total %>% 
  select(ANOOBITO, HORAOBITO) %>% 
  mutate(
  ANOOBITO = as.factor(ANOOBITO),
  horas = HORAOBITO %/% 100, 
  faixa_hora = cut(
    horas,
    breaks = c(-Inf, 2, 4, 6, 8, 10, 12, 14, 16, 18, 20, 22, Inf),
    labels = c("00:00-01:59", "02:00-03:59", "04:00-05:59", "06:00-07:59", "08:00-09:59", 
               "10:00-11:59", "12:00-13:59", "14:00-15:59", "16:00-17:59", "18:00-19:59", 
               "20:00-21:59", "22:00-23:59"),
    right = FALSE)) %>% 
  group_by(ANOOBITO, faixa_hora) %>% 
  summarise(N.obitos = n(), .groups = 'drop') %>% 
  group_by(ANOOBITO) %>% 
  mutate(proporcao = N.obitos / sum(N.obitos))

  
  

# Plotando o Mapa de Calor
mapa_calor_hora_br_total <- ggplot(dados_hora_br_total, 
                                   aes(x = ANOOBITO, 
                                      y = fct_rev(fct_reorder(faixa_hora, as.numeric(substr(faixa_hora, 1, 2)))),
                                      fill = proporcao,
                                      text = paste("Ano: ", ANOOBITO,
                                                   "<br>Proporção: ", proporcao,
                                                   "<br> Faixa de Horário: ", fct_rev(fct_reorder(faixa_hora, as.numeric(substr(faixa_hora, 1, 2))))))) +
  geom_tile(color = "white") +
  scale_fill_gradient(low = "lightblue", high = "#010440",
                      name = "Proporção", limits = c(0,0.14)) +
  labs(x = "Ano", y = "Faixas de Horários (2 em 2 horas)", title = "Mapa de Calor de Óbitos por Ano e Horário no Brasil") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid = element_blank()
  )

# BR PSIC

dados_br_psic$HORAOBITO <- as.numeric(dados_br_psic$HORAOBITO)


dados_hora_br_psic <- dados_br_psic %>% 
  select(ANOOBITO, HORAOBITO) %>% 
  mutate(
    ANOOBITO = as.factor(ANOOBITO),
    horas = HORAOBITO %/% 100, 
    faixa_hora = cut(
      horas,
      breaks = c(-Inf, 2, 4, 6, 8, 10, 12, 14, 16, 18, 20, 22, Inf),
      labels = c("00:00-01:59", "02:00-03:59", "04:00-05:59", "06:00-07:59", "08:00-09:59", 
                 "10:00-11:59", "12:00-13:59", "14:00-15:59", "16:00-17:59", "18:00-19:59", 
                 "20:00-21:59", "22:00-23:59"),
      right = FALSE)) %>% 
  group_by(ANOOBITO, faixa_hora) %>% 
  summarise(N.obitos = n(), .groups = 'drop') %>% 
  group_by(ANOOBITO) %>% 
  mutate(proporcao = N.obitos / sum(N.obitos))




# Plotando o Mapa de Calor
mapa_calor_hora_br_psic <- ggplot(dados_hora_br_psic, 
                                   aes(x = ANOOBITO, 
                                       y = fct_rev(fct_reorder(faixa_hora, as.numeric(substr(faixa_hora, 1, 2)))),
                                       fill = proporcao,
                                       text = paste("Ano: ", ANOOBITO,
                                                    "<br>Proporção: ", proporcao,
                                                    "<br> Faixa de Horário: ", fct_rev(fct_reorder(faixa_hora, as.numeric(substr(faixa_hora, 1, 2))))))) +
  geom_tile(color = "white") +
  scale_fill_gradient(low = "lightblue", high = "#010440",
                      name = "Proporção", limits = c(0,0.14)) + 
  labs(x = "Ano", y = "Faixas de Horários (2 em 2 horas)", title = "Mapa de Calor de Óbitos por Psicoativos por Ano e Horário no Brasil") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid = element_blank()
  )


# ES TOTAL

dados_es_total$HORAOBITO <- as.numeric(dados_es_total$HORAOBITO)


dados_hora_es_total <- dados_es_total %>% 
  select(ANOOBITO, HORAOBITO) %>% 
  mutate(
    ANOOBITO = as.factor(ANOOBITO),
    horas = HORAOBITO %/% 100, 
    faixa_hora = cut(
      horas,
      breaks = c(-Inf, 2, 4, 6, 8, 10, 12, 14, 16, 18, 20, 22, Inf),
      labels = c("00:00-01:59", "02:00-03:59", "04:00-05:59", "06:00-07:59", "08:00-09:59", 
                 "10:00-11:59", "12:00-13:59", "14:00-15:59", "16:00-17:59", "18:00-19:59", 
                 "20:00-21:59", "22:00-23:59"),
      right = FALSE)) %>% 
  group_by(ANOOBITO, faixa_hora) %>% 
  summarise(N.obitos = n(), .groups = 'drop') %>% 
  group_by(ANOOBITO) %>% 
  mutate(proporcao = N.obitos / sum(N.obitos))




# Plotando o Mapa de Calor
mapa_calor_hora_es_total <- ggplot(dados_hora_es_total, 
                                   aes(x = ANOOBITO, 
                                       y = fct_rev(fct_reorder(faixa_hora, as.numeric(substr(faixa_hora, 1, 2)))),
                                       fill = proporcao,
                                       text = paste("Ano: ", ANOOBITO,
                                                    "<br>Proporção: ", proporcao,
                                                    "<br> Faixa de Horário: ", fct_rev(fct_reorder(faixa_hora, as.numeric(substr(faixa_hora, 1, 2))))))) +
  geom_tile(color = "white") +
  scale_fill_gradient(low = "lightblue", high = "#010440",
                      name = "Proporção", limits = c(0,0.14)) +
  labs(x = "Ano", y = "Faixas de Horários (2 em 2 horas)", title = "Mapa de Calor de Óbitos por Ano e Horário no ES") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid = element_blank(),
    axis.text.y = element_blank()
  )

# ES PSIC

dados_es_psic$HORAOBITO <- as.numeric(dados_es_psic$HORAOBITO)


dados_hora_es_psic <- dados_es_psic %>% 
  select(ANOOBITO, HORAOBITO) %>% 
  mutate(
    ANOOBITO = as.factor(ANOOBITO),
    horas = HORAOBITO %/% 100, 
    faixa_hora = cut(
      horas,
      breaks = c(-Inf, 2, 4, 6, 8, 10, 12, 14, 16, 18, 20, 22, Inf),
      labels = c("00:00-01:59", "02:00-03:59", "04:00-05:59", "06:00-07:59", "08:00-09:59", 
                 "10:00-11:59", "12:00-13:59", "14:00-15:59", "16:00-17:59", "18:00-19:59", 
                 "20:00-21:59", "22:00-23:59"),
      right = FALSE)) %>% 
  group_by(ANOOBITO, faixa_hora) %>% 
  summarise(N.obitos = n(), .groups = 'drop') %>% 
  group_by(ANOOBITO) %>% 
  mutate(proporcao = N.obitos / sum(N.obitos))




# Plotando o Mapa de Calor
mapa_calor_hora_es_psic <- ggplot(dados_hora_es_psic, 
                                  aes(x = ANOOBITO, 
                                      y = fct_rev(fct_reorder(faixa_hora, as.numeric(substr(faixa_hora, 1, 2)))),
                                      fill = proporcao,
                                      text = paste("Ano: ", ANOOBITO,
                                                   "<br>Proporção: ", proporcao,
                                                   "<br> Faixa de Horário: ", fct_rev(fct_reorder(faixa_hora, as.numeric(substr(faixa_hora, 1, 2))))))) +
  geom_tile(color = "white") +
  scale_fill_gradient(low = "lightblue", high = "#010440",
                      name = "Proporção", limits = c(0,0.14)) +
  labs(x = "Ano", y = "Faixas de Horários (2 em 2 horas)", title = "Mapa de Calor de Óbitos por Psicoativos por Ano e Horário no ES") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid = element_blank(),
    axis.text.y = element_blank()
  )


```

Quanto a variável horário de ocorrência do óbito, a abordagem para categorização foi criar 12 faixas de 2 horas do dia e verificar a proporção de óbitos em cada uma dessas faixas. Desta forma, ao visualizar os gráficos de calor de mortes totais, é possível perceber uma incidência menor de óbitos de 00:00 às 04:00, aumentando esta incidência a partir das 04:00 horas. No caso do Espírito Santo há uma maior presença de NAs(dados faltantes), vista na primeira linha(linha superior) do gráfico de calor. Já quanto a análise por mortes por psicoativos no Brasil este padrão de ter mais óbitos a partir das 04:00 se repete, porém com uma variância maior entre as proporções por cada faixa de horário. E por fim, o gráfico relacionado a óbitos por psicoativos no Espírito Santo é o único que foge deste padrão dos outros 3 casos, apresentando uma visível maior variância tanto entre as faixas de horário, quanto aos anos de 2013 a 2022, não sendo possível assim averiguar nenhuma tendência aparente.

```{r echo=FALSE, message=FALSE, warning=FALSE}

subplot(style(ggplotly(mapa_calor_hora_br_total, tooltip = "text"),
              showlegend = T)  |> 
          layout(legend = list(orientation = "h",
                               xanchor = "center",
                               x = 0.5),
                 annotations = list(x = 0.2 ,
                                    y = 1.05,
                                    text = "Mortes Totais BR",
                                    showarrow = F, 
                                    xref='paper', 
                                    yref='paper'),
                 xaxis = list(tickfont = list(size = 10)),
                 yaxis = list(tickfont = list(size = 10))),
        style(ggplotly(mapa_calor_hora_es_total, tooltip = "text"), 
              showlegend = FALSE)  |> 
          layout(annotations = list(x = 0.6 ,
                                    y = 1.05,
                                    text = "Mortes Totais ES",
                                    showarrow = F,
                                    xref='paper', 
                                    yref='paper'),
                 xaxis = list(tickfont = list(size = 10)),
                 yaxis = list(tickfont = list(size = 10))))  |> 
  layout(title = 'Óbitos por Horário de Ocorrência')
 
subplot(style( ggplotly(mapa_calor_hora_br_psic, tooltip = "text"), showlegend = T)  |> 
          layout(legend = list(orientation = "h",
                               xanchor = "center",
                               x = 0.5),
                 annotations = list(x = 0.2 ,
                                    y = 1.05,
                                    text = "Mortes Psicoativos BR",
                                    showarrow = F,
                                    xref='paper',
                                    yref='paper'),
                 xaxis = list(tickfont = list(size = 10)),
                 yaxis = list(tickfont = list(size = 10))),
        style(ggplotly(mapa_calor_hora_es_psic, tooltip = "text"), showlegend = F)  |> 
          layout(annotations = list(x = 0.8 ,
                                    y = 1.05,
                                    text = "Mortes Psicoativos ES",
                                    showarrow = F,
                                    xref='paper',
                                    yref='paper'),
                 xaxis = list(tickfont = list(size = 10)),
                 yaxis = list(tickfont = list(size = 10)))) |>
  layout(title = "")
```


# Local de Ocorrência

```{r}

## LOCOCOR

dados_local_es_series <- data.frame(
  dados_es_total %>% group_by(ANOOBITO, LOCOCOR) %>%
    summarise(N.obitos = n())
)

dados_local_br_series <- data.frame(
  dados_br_total %>% group_by(ANOOBITO, LOCOCOR) %>%
    summarise(N.obitos = n()) %>% 
    mutate(LOCOCOR = case_when(
      LOCOCOR == 6 ~ "Aldeia Indígena",
      TRUE ~ LOCOCOR
    ))
)

dados_local_es_psic_series <- data.frame(
  dados_es_psic %>% group_by(ANOOBITO, LOCOCOR) %>%
    summarise(N.obitos = n())
)

dados_local_br_psic_series <- data.frame(
  dados_br_psic %>% group_by(ANOOBITO, LOCOCOR) %>%
    summarise(N.obitos = n())%>% 
    mutate(LOCOCOR = case_when(
      LOCOCOR == 6 ~ "Aldeia Indígena",
      TRUE ~ LOCOCOR
    ))
)



## Gráficos 

# BR TOTAL
series_local_br_total<- ggplot(data = dados_local_br_series, 
                                       aes(x = ANOOBITO, y = N.obitos/1000,
                                                    colour = LOCOCOR)) +
  geom_line(linewidth = 0.5, linetype = "solid", show.legend = F) +
  geom_point(shape = 15, aes(colour = LOCOCOR,
                             text  = paste("Ano: ", ANOOBITO,
                                           "<br>Quantidade: ", N.obitos/1000,
                                           "<br>Local de Ocorrência: ", LOCOCOR))) +
  scale_colour_manual(values =  paleta_lococor)+
  labs(title = "Número de Óbitos Totais no Brasil por Local de Ocorrência",
       x="Anos", y="Óbitos Totais por 1000 habitantes", colour = "") +
  scale_x_continuous(
    breaks = dados_local_br_series$ANOOBITO,
    labels = dados_local_br_series$ANOOBITO)+
  theme_classic()+
  theme(plot.title = element_text(size = 15),
        legend.title = element_text(size = size_titulo_legenda),
        legend.text = element_text(size = size_texto_legenda))


# ES TOTAL
series_local_es_total<- ggplot(data = dados_local_es_series, 
                               aes(x = ANOOBITO, y = N.obitos,
                                   colour = LOCOCOR)) +
  geom_line(linewidth = 0.5, linetype = "solid") +
  geom_point(shape = 15, aes(colour = LOCOCOR,
                             text  = paste("Ano: ", ANOOBITO,
                                           "<br>Quantidade: ", N.obitos,
                                           "<br>Local de Ocorrência: ", LOCOCOR))) +
  scale_colour_manual(values =  paleta_lococor)+
  labs(title = "Número de Óbitos Totais no ES por Local de Ocorrência",
       x="Anos", y="Óbitos Totais", colour = "") +
  scale_x_continuous(
    breaks = dados_local_es_series$ANOOBITO,
    labels = dados_local_es_series$ANOOBITO)+
  theme_classic()+
  theme(plot.title = element_text(size = 15),
        legend.title = element_text(size = size_titulo_legenda),
        legend.text = element_text(size = size_texto_legenda))


# BR PSIC
series_local_br_psic<- ggplot(data = dados_local_br_psic_series, 
                               aes(x = ANOOBITO, y = N.obitos,
                                   colour = LOCOCOR)) +
  geom_line(linewidth = 0.5, linetype = "solid") +
  geom_point(shape = 15, aes(colour = LOCOCOR,
                             text  = paste("Ano: ", ANOOBITO,
                                           "<br>Quantidade: ", N.obitos,
                                           "<br>Local de Ocorrência: ", LOCOCOR))) +
  scale_colour_manual(values =  paleta_lococor)+
  labs(title = "Número de Óbitos por Psicoativos no Brasil por Local de Ocorrência",
       x="Anos", y="Óbitos Totais", colour = "") +
  scale_x_continuous(
    breaks = dados_local_br_psic_series$ANOOBITO,
    labels = dados_local_br_psic_series$ANOOBITO)+
  theme_classic()+
  theme(plot.title = element_text(size = 15),
        legend.title = element_text(size = size_titulo_legenda),
        legend.text = element_text(size = size_texto_legenda))

# ES PSIC
series_local_es_psic<- ggplot(data = dados_local_es_psic_series, 
                              aes(x = ANOOBITO, y = N.obitos,
                                  colour = LOCOCOR)) +
  geom_line(linewidth = 0.5, linetype = "solid") +
  geom_point(shape = 15, aes(colour = LOCOCOR,
                             text  = paste("Ano: ", ANOOBITO,
                                           "<br>Quantidade: ", N.obitos,
                                           "<br>Local de Ocorrência: ", LOCOCOR))) +
  scale_colour_manual(values =  paleta_lococor)+
  labs(title = "Número de Óbitos por Psicoativos no ES por Local de Ocorrência",
       x="Anos", y="Óbitos Totais", colour = "") +
  scale_x_continuous(
    breaks = dados_local_es_psic_series$ANOOBITO,
    labels = dados_local_es_psic_series$ANOOBITO)+
  theme_classic()+
  theme(plot.title = element_text(size = 15),
        legend.title = element_text(size = size_titulo_legenda),
        legend.text = element_text(size = size_texto_legenda))

```

Esta variável indica o local em que ocorreu o óbito. O que é possível perceber é que quanto as mortes totais, tanto no Brasil quanto no Espírito Santo, o local que possui mais ocorrências são os hospitais, e em segundo, porém com uma diferença bem grande na quantidade, os óbitos domiciliares. Outros locais tem quantidades menores ainda. No entanto, quando a morte é por substâncias psicoativas, o número em domícilio é maior, proporcionalmente, que nos óbitos totais, se aproximando assim do número de mortes nos hospitais, tanto no Brasil, quanto no Espírito Santo. Ademais, é interessante notar, entretanto, que nos anos de 2020, 2021, tanto no Brasil, quanto no Espírito Santo, o número de óbitos por psicoativos em domícilios aumenta consideravelmente se comparado aos anos anteriores, tendo assim a partir de 2020 mais mortes que nos hospitais, e em 2022, mesmo registrada uma leve queda, este número ainda se manteve maior que o número de mortes em hospitais. É razoável entender as medidas de distanciamento social e lockdown no contexto da Pandemia da Covid-19 como causas deste comportamento dos óbitos por psicoativos categorizados pelos locais de ocorrência dos óbitos.


```{r echo=FALSE, message=FALSE, warning=FALSE}
subplot(style(ggplotly(series_local_br_total, tooltip = "text"),
              showlegend = T)  |> 
          layout(legend = list(orientation = "h",
                               xanchor = "center",
                               x = 0.5),
                 annotations = list(x = 0.2 ,
                                    y = 1.05,
                                    text = "Mortes Totais BR por 1000",
                                    showarrow = F, 
                                    xref='paper', 
                                    yref='paper'),
                 xaxis = list(tickfont = list(size = 10)),
                 yaxis = list(tickfont = list(size = 10))),
        style(ggplotly(series_local_es_total, tooltip = "text"), 
              showlegend = FALSE)  |> 
          layout(annotations = list(x = 0.6 ,
                                    y = 1.05,
                                    text = "Mortes Totais ES",
                                    showarrow = F,
                                    xref='paper', 
                                    yref='paper'),
                 xaxis = list(tickfont = list(size = 10)),
                 yaxis = list(tickfont = list(size = 10))))  |> 
  layout(title = 'Óbitos por Local de Ocorrência')
 
subplot(style( ggplotly(series_local_br_psic, tooltip = "text"), showlegend = T)  |> 
          layout(legend = list(orientation = "h",
                               xanchor = "center",
                               x = 0.5),
                 annotations = list(x = 0.2 ,
                                    y = 1.05,
                                    text = "Mortes Psicoativos BR",
                                    showarrow = F,
                                    xref='paper',
                                    yref='paper'),
                 xaxis = list(tickfont = list(size = 10)),
                 yaxis = list(tickfont = list(size = 10))),
        style(ggplotly(series_local_es_psic, tooltip = "text"), showlegend = F)  |> 
          layout(annotations = list(x = 0.6 ,
                                    y = 1.05,
                                    text = "Mortes Psicoativos ES",
                                    showarrow = F,
                                    xref='paper',
                                    yref='paper'),
                 xaxis = list(tickfont = list(size = 10)),
                 yaxis = list(tickfont = list(size = 10)))) |>
  layout(title = "")
```

# Ocupação

```{r}
library(tidytext)
library(wordcloud2)
library(ggwordcloud)
library(htmlwidgets)
library(wordcloud)

## OCUPAÇÃO

dados_ocup_es <- data.frame(
  dados_es_total %>% group_by(ANOOBITO, OCUP) %>%
    summarise(N.obitos = n())
)

dados_ocup_br <- data.frame(
  dados_br_total %>% group_by(ANOOBITO, OCUP) %>%
    summarise(N.obitos = n())
)
  
dados_ocup_es_psic <- data.frame(
  dados_es_psic %>% group_by(ANOOBITO, OCUP) %>%
    summarise(N.obitos = n())
)

dados_ocup_br_psic <- data.frame(
  dados_br_psic %>% group_by(ANOOBITO, OCUP) %>%
    summarise(N.obitos = n())
)


# 1. Saúde
regex_saude <- "(?i)\\b(enfermeiro|psic[oó]logo|m[eé]dico|dentista|sa[uú]de|t[eé]cnico de enfermagem|auxiliar de enfermagem|laborat[oó]rio|cirurgi[aã]o)\\b"

# 2. Educação
regex_educacao <- "(?i)\\b(professor|pedagogo|educa[cç][aã]o|ensino|instrutor|pesquisador|escola|fundamental)\\b"

# 3. Agronegócio
regex_agro <- "(?i)\\b(agricultura|agricola|feirante|agricultor|pecu[aá]ria|agropec[uú]ario|trabalhador da cultura|pescador|pecuarista|caseiro|trabalhador rural|pecuaria|oleri[aã]cultura|florestal|cultivo|produtor)\\b"

# 4. Serviços Gerais
regex_servicos <- "(?i)\\b(relojeiro|joalheiro|borracheiro|vendedor|cabeleireiro|sapateiro|comerciante|costurador|padeiro|maquinista|frentista|contador|lavador|lavadora|lavadeir[oa]|jardineiro|cobrador|cozinha|carregador|a[cç]ougueiro|fot[óo]grafo|encanador|dom[eé]stico|diarista|cozinhadora|cozinhador|cozinheir[oa]|costureir[ao]|assistente|catador|faxineiro|porteiro|motorista|vendedor|gar[cç]om|manicure|pedicuro|vigilante|auxiliar geral|atendente|coletor de lixo|varredor de rua|balconista|cobrador|camareiro|recepcionista|motorista)\\b"

# 5. Segurança e Justiça
regex_seguranca_justica <- "(?i)\\b(justi[cç]a|advogado|juiz|vigilante|policial|bombeiro|investigador|seguran[cç]a|guarda|soldado|vigia|cabo|taifeiro|pol[ií]cia|fiscal|procurador|militar|oficial|bombeiro|policial)\\b"

# 6. Indústria, Mecânica, Elétrica, Construção Civil
regex_industria_construcao <- "(?i)\\b(engenharia|construçao|el[ée]trica|mec[âa]nica|ind[uú]stria|ve[ií]culos|marceneiro|eletr[oô]nico|produ[cç]ao|metal[úu]rgico|metalurgia|linha de produ[cç][aã]o|pedreiro|engenheiro|mestre|obra|carpinteiro|armador|gesseiro|pintor de obras|servente|serralheiro|montador de andaimes|montador de estruturas metalicas|operador|mec[aâ]nico|soldador|montador|ajustador|eletricista|m[aá]quinas|embalador|conferente|bobinador|art[ií]fice|supervisor|manuten[cç][aã]o|instalador|usinagem|ferramenteiro|industria|fabricac[aã]o|constru[cç][aã]o|tecel[aã]o|metalicas|produtoras|vidraceiro|engenharia|sistemas|tecnicos)\\b"

# 7. Tecnologia e Setor Financeiro
regex_tecnologia_financeiro <- "(?i)\\b(telecomunica[cç][oõ]es|computa[cç][aã]o|analista|tecnologia|desenvolvedor|inform[aá]tica|sistemas|projetista|administrativo|contabil[íí]stico|financeiro|bancos|empresa||banc[aã]rio|analista de credito|auditor|consultor|tesoureiro|gestor|planejador|controlador|economista|financiamento|bancario|administracao financeira|auditoria)\\b"




dados_ocup_br <- dados_br_total %>%
  mutate(categoria_ocupacao = case_when(
    is.na(OCUP) ~ NA_character_,
    str_detect(OCUP, regex_saude) ~ "Saúde",
    str_detect(OCUP, regex_educacao) ~ "Educação",
    str_detect(OCUP, regex_agro) ~ "Agropecuária",
    str_detect(OCUP, regex_servicos) ~ "Serviços Gerais",
    str_detect(OCUP, regex_seguranca_justica) ~ "Justiça e Segurança",
    str_detect(OCUP, regex_industria_construcao) ~ "Indústria, Mecânica, Elétrica e Construção Civil",
    #str_detect(OCUP, regex_tecnologia_financeiro) ~ "Tecnologia e Setor Financeiro",
    TRUE ~ "Outros"
  )) %>% 
  group_by(ANOOBITO, categoria_ocupacao) %>%
  summarise(N.obitos = n())







dados_ocup_es <- dados_es_total %>%
  mutate(categoria_ocupacao = case_when(
    is.na(OCUP) ~ NA_character_,
    str_detect(OCUP, regex_saude) ~ "Saúde",
    str_detect(OCUP, regex_educacao) ~ "Educação",
    str_detect(OCUP, regex_agro) ~ "Agropecuária",
    str_detect(OCUP, regex_servicos) ~ "Serviços Gerais",
    str_detect(OCUP, regex_seguranca_justica) ~ "Justiça e Segurança",
    str_detect(OCUP, regex_industria_construcao) ~ "Indústria, Mecânica, Elétrica e Construção Civil",
    #str_detect(OCUP, regex_tecnologia_financeiro) ~ "Tecnologia e Setor Financeiro",
    TRUE ~ "Outros"
  )) %>% 
  group_by(ANOOBITO, categoria_ocupacao) %>%
  summarise(N.obitos = n())







dados_ocup_es_psic <- dados_es_psic %>%
  mutate(categoria_ocupacao = case_when(
    is.na(OCUP) ~ NA_character_,
    str_detect(OCUP, regex_saude) ~ "Saúde",
    str_detect(OCUP, regex_educacao) ~ "Educação",
    str_detect(OCUP, regex_agro) ~ "Agropecuária",
    str_detect(OCUP, regex_servicos) ~ "Serviços Gerais",
    str_detect(OCUP, regex_seguranca_justica) ~ "Justiça e Segurança",
    str_detect(OCUP, regex_industria_construcao) ~ "Indústria, Mecânica, Elétrica e Construção Civil",
    #str_detect(OCUP, regex_tecnologia_financeiro) ~ "Tecnologia e Setor Financeiro",
    TRUE ~ "Outros"
  )) %>% 
  group_by(ANOOBITO, categoria_ocupacao) %>%
  summarise(N.obitos = n())
  



dados_ocup_br_psic <- dados_br_total %>%
  mutate(categoria_ocupacao = case_when(
    is.na(OCUP) ~ NA_character_,
    str_detect(OCUP, regex_saude) ~ "Saúde",
    str_detect(OCUP, regex_educacao) ~ "Educação",
    str_detect(OCUP, regex_agro) ~ "Agropecuária",
    str_detect(OCUP, regex_servicos) ~ "Serviços Gerais",
    str_detect(OCUP, regex_seguranca_justica) ~ "Justiça e Segurança",
    str_detect(OCUP, regex_industria_construcao) ~ "Indústria, Mecânica, Elétrica e Construção Civil",
    #str_detect(OCUP, regex_tecnologia_financeiro) ~ "Tecnologia e Setor Financeiro",
    TRUE ~ "Outros"
  )) %>% 
  group_by(ANOOBITO, categoria_ocupacao) %>%
  summarise(N.obitos = n())


## GRÁFICOS

series_ocup_br<- ggplot(data = dados_ocup_br, 
                        aes(x = ANOOBITO, y = N.obitos/1000,
                            colour = categoria_ocupacao)) +
  geom_line(linewidth = 0.5, linetype = "solid") +
  geom_point(shape = 15, aes(colour = categoria_ocupacao,
                             text  = paste("Ano: ", ANOOBITO,
                                           "<br>Quantidade: ", N.obitos/1000,
                                           "<br>Área de Ocupação: ", categoria_ocupacao))) +
  scale_colour_manual(values =  paleta_series(10))+
  labs(title = "Número de Óbitos Totais no Brasil por Área de Ocupação",
       x="Anos", y="Óbitos Totais/1000", colour = "") +
  scale_x_continuous(
    breaks = dados_ocup_es$ANOOBITO,
    labels = dados_ocup_es$ANOOBITO)+
  theme_classic()+
  theme(plot.title = element_text(size = 15),
        legend.title = element_text(size = size_titulo_legenda),
        legend.text = element_text(size = size_texto_legenda))



series_ocup_es<- ggplot(data = dados_ocup_es, 
                             aes(x = ANOOBITO, y = N.obitos,
                                 colour = categoria_ocupacao)) +
  geom_line(linewidth = 0.5, linetype = "solid") +
  geom_point(shape = 15, aes(colour = categoria_ocupacao,
                             text  = paste("Ano: ", ANOOBITO,
                                           "<br>Quantidade: ", N.obitos,
                                           "<br>Área de Ocupação: ", categoria_ocupacao))) +
  scale_colour_manual(values =  paleta_series(10))+
  labs(title = "Número de Óbitos Totais no ES por Área de Ocupação",
       x="Anos", y="Óbitos Totais", colour = "") +
  scale_x_continuous(
    breaks = dados_ocup_es$ANOOBITO,
    labels = dados_ocup_es$ANOOBITO)+
  theme_classic()+
  theme(plot.title = element_text(size = 15),
        legend.title = element_text(size = size_titulo_legenda),
        legend.text = element_text(size = size_texto_legenda))



series_ocup_br_psic<- ggplot(data = dados_ocup_br_psic, 
                             aes(x = ANOOBITO, y = N.obitos/1000,
                                 colour = categoria_ocupacao)) +
  geom_line(linewidth = 0.5, linetype = "solid") +
  geom_point(shape = 15, aes(colour = categoria_ocupacao,
                             text  = paste("Ano: ", ANOOBITO,
                                           "<br>Quantidade: ", N.obitos/1000,
                                           "<br>Área de Ocupação: ", categoria_ocupacao))) +
  scale_colour_manual(values =  paleta_series(10))+
  labs(title = "Número de Óbitos por Psicoativos no Brasil por Área de Ocupação",
       x="Anos", y="Óbitos Totais", colour = "") +
  scale_x_continuous(
    breaks = dados_ocup_br_psic$ANOOBITO,
    labels = dados_ocup_br_psic$ANOOBITO)+
  theme_classic()+
  theme(plot.title = element_text(size = 15),
        legend.title = element_text(size = size_titulo_legenda),
        legend.text = element_text(size = size_texto_legenda))


series_ocup_es_psic<- ggplot(data = dados_ocup_es_psic, 
                              aes(x = ANOOBITO, y = N.obitos,
                                  colour = categoria_ocupacao)) +
  geom_line(linewidth = 0.5, linetype = "solid") +
  geom_point(shape = 15, aes(colour = categoria_ocupacao,
                             text  = paste("Ano: ", ANOOBITO,
                                           "<br>Quantidade: ", N.obitos,
                                           "<br>Área de Ocupação: ", categoria_ocupacao))) +
  scale_colour_manual(values =  paleta_series(10))+
  labs(title = "Número de Óbitos por Psicoativos no ES por Área de Ocupação",
       x="Anos", y="Óbitos Totais", colour = "") +
  scale_x_continuous(
    breaks = dados_ocup_es_psic$ANOOBITO,
    labels = dados_ocup_es_psic$ANOOBITO)+
  theme_classic()+
  theme(plot.title = element_text(size = 15),
        legend.title = element_text(size = size_titulo_legenda),
        legend.text = element_text(size = size_texto_legenda))



# NUVEM DE PALAVRAS


stopwords_pt <- c("de", "da", "do", "e", "o", "a", "em", 
                  "para", "com", "geral", "gerais",
                  "nos", "na", "exceto", "ou")  # Exemplo para o português


palavras_ocupacao_br <- dados_br_psic %>%
 unnest_tokens(word, OCUP) %>%
 count(word, sort = TRUE)


palavras_ocupacao_filtradas_br <- palavras_ocupacao_br %>%
  filter(!word %in% stopwords_pt) %>% 
  filter(n >= 10) %>% na.omit(words)



palavras_ocupacao_es <- dados_es_psic %>%
  unnest_tokens(word, OCUP) %>%
  count(word, sort = TRUE)


palavras_ocupacao_filtradas_es <- palavras_ocupacao_es %>%
  filter(!word %in% stopwords_pt) %>% 
  filter(n >= 10) %>% na.omit(words)



set.seed(0411)
wordcloud_br_estatica <- ggplot(palavras_ocupacao_filtradas_br, aes(label = word, size = n)) +
  geom_text_wordcloud_area(eccentricity = 1) +
  scale_size_area(max_size = 40) +
  theme_minimal()

wordcloud_es_estatica <- ggplot(palavras_ocupacao_filtradas_es, aes(label = word, size = n)) +
  geom_text_wordcloud_area(eccentricity = 1) +
  scale_size_area(max_size = 40) +
  theme_minimal()
```


Esta variável representa a ocupação que o falecido teve na maior parte da sua vida seguindo a Classificação Brasileira de Ocupações(CBO, 2002). Em um primeiro momento, as nuvens de palavras mais frequentes, tanto para o caso de mortes por psicoativos no Brasil, quanto no Espírito Santo, dão uma ideia inicial das profissões ou áreas que mais aparecem neste recorte. A frequência da palavra é diretamente proporcional ao tamanho em que ela aparece na nuvem.


### Nuvem de palavras - Óbitos por psicoativos no Brasil

```{r echo=FALSE, message=FALSE, warning=FALSE}
wordcloud_br_estatica
```

### Nuvem de palavras - Óbitos por psicoativos no Espírito Santo

```{r echo=FALSE, message=FALSE, warning=FALSE}
wordcloud_es_estatica
```




Em seguida, a análise por gráfico de séries traz uma visualização mais rigorosa das áreas de ocupação ao longo do tempo. Devido ao fato de ter um número muito grande de ocupações dentre os dados analisados, foram criadas categorias seguindo áreas de atuação. As categorias foram Agropecuária; Educação; Indústria, Mecânica, Elétrica e Construção Civil; Justiça e Segurança; Saúde; Serviços Gerais; e Outros, que engloba outras ocupações que não alocadas em uma das categorias criadas. Com uma grande presença de dados faltantes, uma conclusão mais assertiva não pode ser apresentada. No entanto, dentre as observações existentes, no caso dos óbitos por psicoativos no Brasil, há uma presença maior de óbitos nas áreas de Indústria, Mecânica, Elétrica e Construção Civil; e na área de Serviços Gerais. No caso do Espírito Santo, estas duas áreas levam a maior parte dos óbitos, junto, desta vez, com a área de Agropecuária.



```{r echo=FALSE, message=FALSE, warning=FALSE}
subplot(style(ggplotly(series_ocup_br, tooltip = "text"),
              showlegend = T)  |> 
          layout(legend = list(orientation = "h",
                               xanchor = "center",
                               x = 0.5),
                 annotations = list(x = 0.2 ,
                                    y = 1.05,
                                    text = "Mortes Totais BR por 1000",
                                    showarrow = F, 
                                    xref='paper', 
                                    yref='paper'),
                 xaxis = list(tickfont = list(size = 10)),
                 yaxis = list(tickfont = list(size = 10))),
        style(ggplotly(series_ocup_es, tooltip = "text"), 
              showlegend = FALSE)  |> 
          layout(annotations = list(x = 0.6 ,
                                    y = 1.05,
                                    text = "Mortes Totais ES",
                                    showarrow = F,
                                    xref='paper', 
                                    yref='paper'),
                 xaxis = list(tickfont = list(size = 10)),
                 yaxis = list(tickfont = list(size = 10))))  |> 
  layout(title = 'Óbitos por Categoria de Ocupação')
 
subplot(style( ggplotly(series_ocup_br_psic, tooltip = "text"), showlegend = T)  |> 
          layout(legend = list(orientation = "h",
                               xanchor = "center",
                               x = 0.5),
                 annotations = list(x = 0.2 ,
                                    y = 1.05,
                                    text = "Mortes Psicoativos BR por 1000",
                                    showarrow = F,
                                    xref='paper',
                                    yref='paper'),
                 xaxis = list(tickfont = list(size = 10)),
                 yaxis = list(tickfont = list(size = 10))),
        style(ggplotly(series_ocup_es_psic, tooltip = "text"), showlegend = F)  |> 
          layout(annotations = list(x = 0.6 ,
                                    y = 1.05,
                                    text = "Mortes Psicoativos ES",
                                    showarrow = F,
                                    xref='paper',
                                    yref='paper'),
                 xaxis = list(tickfont = list(size = 10)),
                 yaxis = list(tickfont = list(size = 10)))) |>
  layout(title = "")
```